---
title: "QTM 150 Final Presentation"
author: "Nick Huberty"
date: "`r Sys.Date()`"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(rJava)
install.packages("xlsx")
library(xlsx)
library(tidyverse)
install.packages("ggridges")
library(ggridges)
install.packages("common")
library(common)

pistols <- read.csv("pistols_manufacturers.csv")
pistols <- pistols %>% select(where(~any(!is.na(.))))
pistols$Street <- coalesce(pistols$Street, pistols$X.4)
pistols$X.4 <- NULL

precip <- read.csv("precipitation-1.csv", skip=3)
drought <- read.csv("drought_severity_index-1.csv", skip=2)
temp <- read.csv("average_temp-1.csv", skip=3)
agriculture <- read.csv("US_Counties_Agriculture_Census_(USDA)-1.csv")
population <- read.xlsx("co-est2024-pop-1.xlsx", sheetIndex=1)
population <- population[-1,]
population <- population[1:3144,]
population$Geographic.Area <- substr(population$Geographic.Area, 2, 100)
population <- population %>% separate(
  Geographic.Area, 
  into=c("County", "State"),
  sep=","
)
population$County <- tolower(population$County)
population$County <- gsub("[^a-z0-9]", "", population$County)
temp$Name <- tolower(temp$Name)
temp$Name <- gsub("[^a-z0-9]", "", temp$Name)
drought$Name <- tolower(drought$Name)
drought$Name <- gsub("[^a-z0-9]", "", drought$Name)
precip$Name <- tolower(precip$Name)
precip$Name <- gsub("[^a-z0-9]", "", precip$Name)
agriculture$atlas_name <- tolower(agriculture$atlas_name)
agriculture$atlas_name <- gsub("[^a-z0-9]", "", agriculture$atlas_name)
agriculture$atlas_name <- paste0(agriculture$atlas_name, "county")

combined_data <- merge(temp[,1:5], precip[,c(1,4,5)], by="ID")
combined_data <- merge(combined_data, drought[,c(1,4,5)], by="ID")
combined_data <- combined_data %>% rename(
  temp = Value.x,
  precip = Value.y,
  drought = Value
)
combined_data$Name <- paste0(combined_data$Name, tolower(combined_data$State))
agriculture$atlas_name <- paste0(agriculture$atlas_name, 
                                 tolower(agriculture$State))
combined_data <- merge(combined_data, agriculture, by.x="Name", 
                       by.y="atlas_name", all.x=TRUE)
population$State <- substr(population$State, 2, 1000)
population$County <- paste0(population$County, tolower(population$State))
combined_data <- merge(combined_data, population, by.x="Name", by.y="County", 
                       all.x=TRUE)

cities <- read.csv("uscities.csv")
pistols$City <- tolower(pistols$City)
pistols$City <- gsub("[^a-z0-9]", "", pistols$City)
pistols$City <- paste0(pistols$City, tolower(pistols$State))
cities$city_ascii <- tolower(cities$city_ascii)
cities$city_ascii <- gsub("[^a-z0-9]", "", cities$city_ascii)
cities$city_ascii <- paste0(cities$city_ascii, tolower(cities$state_id))
cities <- cities %>% distinct(city_ascii, .keep_all=TRUE)
pistols <- pistols %>% distinct(RDS.Key, .keep_all=TRUE)
pistols <- merge(pistols, cities[,2:6], by.x="City", by.y="city_ascii", 
                 all.x=TRUE)
pistols <- pistols %>% filter(!is.na(county_name))
pistols$county_name <- tolower(pistols$county_name)
pistols$county_name <- gsub("[^a-z0-9]", "", pistols$county_name)
pistols$county_name <- paste0(pistols$county_name, "county") 
pistols$county_name <- paste0(pistols$county_name,  
                              tolower(pistols$state_name))
pistols <- pistols %>% select(TOTAL, state_name, county_name) %>%
  group_by(county_name, state_name) %>%
  summarize(
    total_pistols = sum(TOTAL, na.rm=TRUE)
  )
combined_data <- merge(combined_data, pistols, by.x="Name", by.y="county_name", 
                       all.x=TRUE)
combined_data$total_pistols[is.na(combined_data$total_pistols)] <- 0
combined_data$gun_manufacturer <- combined_data$total_pistols != 0

write.csv(combined_data, "combined_data-2", row.names=FALSE)

combined_data <- combined_data %>% mutate(
  pop_density = X2024/atlas_area,
  percent_farmland = LandinFarmsAcr/atlas_acre
)

min_temp <- read.csv("jan_min_temp.csv", skip=3)
max_temp <- read.csv("july_max_temp.csv", skip=3)

min_temp <- min_temp %>% select(ID, Value) %>% rename(min_temp = Value)
max_temp <- max_temp %>% select(ID, Value) %>% rename(max_temp = Value)

combined_data <- merge(combined_data, min_temp, by="ID", all.x=TRUE)
combined_data <- merge(combined_data, max_temp, by="ID", all.x=TRUE)

combined_data <- combined_data %>% mutate(
  percent_farm_failed = FailedCropAcr/CroplandAcr
)

avg_temp <- read.csv("avg_temp-2.csv", skip=3)
combined_data <- merge(combined_data, avg_temp %>% select(ID, Value) %>% rename(avg_temp = Value), by="ID")

combined_data <- combined_data %>% mutate(temp_range = max_temp-min_temp)

indicies <- combined_data %>% select(
  ID, 
  Name, 
  pop_density, 
  percent_farmland, 
  gun_manufacturer, 
  percent_farm_failed, 
  avg_temp, 
  temp_range, 
  drought) %>% 
  mutate(
    p_1 = (pop_density^3)/1000000, 
    pf_1 = (1.5/percent_farmland) - 1.5,
    g_1 = -1000 * (as.numeric(gun_manufacturer) - 1),
    ff_1 = (percent_farm_failed^3)/0.01,
    at_1 = ((avg_temp-60)^2)/25,
    tr_1 = (temp_range^2)/5625,
    d_1 = ((drought-1.5)^4)/5.0625,
    index_1 = p_1 + pf_1 + g_1 + ff_1 + at_1 + tr_1 + d_1) %>%
  arrange((index_1))

combined_data <- combined_data %>% 
  mutate(candidate = pop_density < 100 & percent_farmland > 0.6 & gun_manufacturer) %>%
  left_join(indicies %>% select(ID, index_1), join_by(ID))
```

## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Output

```{r cars, echo = TRUE}
summary(cars)
```

## Slide with Plot

```{r pressure}
plot(pressure)
```







