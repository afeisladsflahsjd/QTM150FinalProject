---
title: "QTM 150 Final Presentation"
author: "Nick Huberty, Alex Nuckols, William Chung, Caroline Ball"
date: "`r Sys.Date()`"
output:
  slidy_presentation: default
  beamer_presentation: default
  ioslides_presentation: default
---

## Introduction To Our Scenario

-   Vmmmm Vmmmm, you get a Twitter notification, a zombie apocalypse has just been announced.

-   Luck! A genie has gifted you a car with unlimited gas in the US - sans Hawaii and Alaska.

-   Bad Luck!, you can drive it just once.

-   Where do you go? This is what we set out to discover in our R project.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(tidyverse)
library(ggridges)
library(common)
library(gridExtra)
library(sf)
library(tigris)
options(tigris_use_cache = TRUE)
library(dplyr)
library(stringr)
library(ggplot2)
library(yaml)
library(rmarkdown)
library(knitr)

pistols <- read.csv("pistols_manufacturers.csv")
pistols <- pistols %>% select(where(~any(!is.na(.))))
pistols$Street <- coalesce(pistols$Street, pistols$X.4)
pistols$X.4 <- NULL

precip <- read.csv("precipitation-1.csv", skip=3)
drought <- read.csv("drought_severity_index-1.csv", skip=2)
temp <- read.csv("average_temp-1.csv", skip=3)
agriculture <- read.csv("US_Counties_Agriculture_Census_(USDA)-1.csv")
population <- read_excel("co-est2024-pop-1.xlsx")
population <- population[-1,]
population <- population[1:3144,]
population$Geographic.Area <- substr(population$'Geographic Area', 2, 100)
population <- population %>% separate(
  Geographic.Area, 
  into=c("County", "State"),
  sep=","
)
population$County <- tolower(population$County)
population$County <- gsub("[^a-z0-9]", "", population$County)
temp$Name <- tolower(temp$Name)
temp$Name <- gsub("[^a-z0-9]", "", temp$Name)
drought$Name <- tolower(drought$Name)
drought$Name <- gsub("[^a-z0-9]", "", drought$Name)
precip$Name <- tolower(precip$Name)
precip$Name <- gsub("[^a-z0-9]", "", precip$Name)
agriculture$atlas_name <- tolower(agriculture$atlas_name)
agriculture$atlas_name <- gsub("[^a-z0-9]", "", agriculture$atlas_name)
agriculture$atlas_name <- paste0(agriculture$atlas_name, "county")

combined_data <- merge(temp[,1:5], precip[,c(1,4,5)], by="ID")
combined_data <- merge(combined_data, drought[,c(1,4,5)], by="ID")
combined_data <- combined_data %>% rename(
  temp = Value.x,
  precip = Value.y,
  drought = Value
)
combined_data$Name <- paste0(combined_data$Name, tolower(combined_data$State))
agriculture$atlas_name <- paste0(agriculture$atlas_name, 
                                 tolower(agriculture$State))
combined_data <- merge(combined_data, agriculture, by.x="Name", 
                       by.y="atlas_name", all.x=TRUE)
population$State <- substr(population$State, 2, 1000)
population$County <- paste0(population$County, tolower(population$State))
combined_data <- merge(combined_data, population, by.x="Name", by.y="County", 
                       all.x=TRUE)

cities <- read.csv("uscities.csv")
pistols$City <- tolower(pistols$City)
pistols$City <- gsub("[^a-z0-9]", "", pistols$City)
pistols$City <- paste0(pistols$City, tolower(pistols$State))
cities$city_ascii <- tolower(cities$city_ascii)
cities$city_ascii <- gsub("[^a-z0-9]", "", cities$city_ascii)
cities$city_ascii <- paste0(cities$city_ascii, tolower(cities$state_id))
cities <- cities %>% distinct(city_ascii, .keep_all=TRUE)
pistols <- pistols %>% distinct(RDS.Key, .keep_all=TRUE)
pistols <- merge(pistols, cities[,2:6], by.x="City", by.y="city_ascii", 
                 all.x=TRUE)
pistols <- pistols %>% filter(!is.na(county_name))
pistols$county_name <- tolower(pistols$county_name)
pistols$county_name <- gsub("[^a-z0-9]", "", pistols$county_name)
pistols$county_name <- paste0(pistols$county_name, "county") 
pistols$county_name <- paste0(pistols$county_name,  
                              tolower(pistols$state_name))
pistols <- pistols %>% select(TOTAL, state_name, county_name) %>%
  group_by(county_name, state_name) %>%
  summarize(
    total_pistols = sum(TOTAL, na.rm=TRUE)
  )
combined_data <- merge(combined_data, pistols, by.x="Name", by.y="county_name", 
                       all.x=TRUE)
combined_data$total_pistols[is.na(combined_data$total_pistols)] <- 0
combined_data$gun_manufacturer <- combined_data$total_pistols != 0

write.csv(combined_data, "combined_data-2", row.names=FALSE)

combined_data <- combined_data %>% mutate(
  pop_density = `2024`/atlas_area,
  percent_farmland = LandinFarmsAcr/atlas_acre
)

min_temp <- read.csv("jan_min_temp.csv", skip=3)
max_temp <- read.csv("july_max_temp.csv", skip=3)

min_temp <- min_temp %>% select(ID, Value) %>% rename(min_temp = Value)
max_temp <- max_temp %>% select(ID, Value) %>% rename(max_temp = Value)

combined_data <- merge(combined_data, min_temp, by="ID", all.x=TRUE)
combined_data <- merge(combined_data, max_temp, by="ID", all.x=TRUE)

combined_data <- combined_data %>% mutate(
  percent_farm_failed = FailedCropAcr/CroplandAcr
)

avg_temp <- read.csv("avg_temp-2.csv", skip=3)
combined_data <- merge(combined_data, avg_temp %>% select(ID, Value) %>% rename(avg_temp = Value), by="ID")

combined_data <- combined_data %>% mutate(temp_range = max_temp-min_temp)

indicies <- combined_data %>% select(
  ID, 
  Name, 
  pop_density, 
  percent_farmland, 
  gun_manufacturer, 
  percent_farm_failed, 
  avg_temp, 
  temp_range, 
  drought) %>% 
  mutate(
    p_1 = (pop_density^3)/1000000, 
    pf_1 = (1.5/percent_farmland) - 1.5,
    g_1 = -1000 * (as.numeric(gun_manufacturer) - 1),
    ff_1 = (percent_farm_failed^3)/0.01,
    at_1 = ((avg_temp-60)^2)/25,
    tr_1 = (temp_range^2)/5625,
    d_1 = ((drought-1.5)^4)/5.0625,
    index_1 = 5000-5000*exp(0.0002*(p_1 + pf_1 + g_1 + ff_1 + at_1 + tr_1 + d_1))) %>%
  arrange((index_1))

combined_data <- combined_data %>% 
  mutate(candidate = pop_density < 100 & percent_farmland > 0.6 & gun_manufacturer) %>%
  left_join(indicies %>% select(ID, index_1), join_by(ID))

options(tigris_use_cache = TRUE)

combined_data <- combined_data %>%
  mutate(
    STATE_ABB = str_sub(ID, 1, 2),
    COUNTY = str_sub(ID, 4, 6)   # always 3 digits
  )

data("fips_codes", package = "tidycensus")

state_crosswalk <- fips_codes %>%
  select(state, state_code) %>% 
  distinct()

combined_data <- combined_data %>%
  left_join(
    state_crosswalk,
    by = c("STATE_ABB" = "state")
  ) %>%
  mutate(
    GEOID = paste0(state_code, COUNTY)
  )

counties_sf <- counties(year = 2020, class = "sf") %>% 
  st_transform(4326)
```

# How we picked candidate counties

-   These counties are our bare bone counties

    -   Enough farm land

    -   Not too many people

    -   Probable to find ammunition

# Beginning with Farming

```{r}

ggplot(combined_data, aes(x=percent_farmland)) + 
  geom_histogram() +
  labs(
    x="Percent Farmland",
    y="Number of Counties",
    title="Percentage of County Area That is Farmland"
  ) +
  theme_minimal()
```

-   This histogram shows us the number of counties with corrosponding amounts of farm land

# Moving on to Population Density

```{r}

ggplot(combined_data, aes(x=pop_density)) + 
  geom_histogram(binwidth=1000) +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Number of Counties",
    title="Contiguous US Counties Population Density Distribution"
  ) +
  theme_minimal()
```

-   This histogram shows us the counties with population densities \<100 per mile\^2

# Combining These

```{r}
ggplot(combined_data, aes(x=pop_density, y=percent_farmland)) + 
  geom_point(alpha = 0.6) +
  labs(
    x="Population Density",
    y="Percent Farmland",
    title="Percent Farmland vs. Population Density"
  ) +
  theme_minimal()
```

-   Given the individual distributions, as well as the scatterplot, we decided threshold values of \<100 people/mi\^2 for population density, and \>60% farmland would be ideal ranges that would give a broad range of candidate counties

# Scatter plot using these thresholds

```{r}

ggplot(combined_data %>% filter(pop_density<100, percent_farmland > 0.6), 
       aes(x=pop_density, y=percent_farmland)) + 
  geom_point(alpha = 0.6) +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Percent Farmland",
    title = "Percent Farmland vs. Population Density",
    subtitle = str_c("Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%")
  ) +
  theme_minimal()
```

-   This scatter plot shows us the candidate counties following our parameters
    -   \>60% farmland
    -   \<100 people/mile square
-   From here we can add our third most important variable to surviving a zombie apocalypse

# Adding Guns

```{r}

ggplot(combined_data %>% filter(pop_density<100, percent_farmland > 0.6), 
       aes(x=pop_density, y=percent_farmland, color = gun_manufacturer)) +
  geom_point() +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Percent Farmland",
    title = "Percent Farmland vs. Population Density",
    subtitle = str_c("Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%"),
    color = "County Has\nGun Manufacturer"
  ) +
  theme_minimal()
```

-   Of our candidates, we take out counties without a gun manufacturer as counties without one would most likely have less ammunition to defend against the zombies
-   This leaves us with a bare bones list of candidate counties

# Comparing Candidate Counties

```{r}
small_text <- theme(
  plot.title    = element_text(size = 9),
  plot.subtitle = element_text(size = 7),
  axis.title    = element_text(size = 7),
  axis.text     = element_text(size = 6),
  legend.title  = element_text(size = 7),
  legend.text   = element_text(size = 6)
)
par(mfrow=c(2,2))
g1 <- ggplot(combined_data %>% filter(candidate), 
       aes(x=pop_density, y=percent_farmland, color = drought)) +
  geom_point(size=0.5, alpha = 0.6) +
  scale_color_gradient(high="red", low="blue") +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Percent Farmland",
    title = "Percent Farmland vs. Population Density",
    subtitle = str_c("Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, \nHas Gun Manufacturer"),
    color = "Drought\nSeverity\nIndex"
  ) +
  theme_minimal() +
  small_text

g2 <- ggplot(combined_data %>% filter(candidate), 
       aes(x=pop_density, y=percent_farmland, color = avg_temp)) +
  geom_point(size=0.5, alpha = 0.6) +
  scale_color_gradient(high="red", low="blue") +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Percent Farmland",
    title = "Percent Farmland vs. Population Density",
    subtitle = str_c("Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, \nHas Gun Manufacturer"),
    color = "Average\nTemperature"
  ) +
  theme_minimal() +
  small_text

g3 <- ggplot(combined_data %>% filter(candidate), 
       aes(x=pop_density, y=percent_farmland, color = temp_range)) +
  geom_point(size=0.5, alpha = 0.6) +
  scale_color_gradient(high="red", low="blue") +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Percent Farmland",
    title = "Percent Farmland vs. Population Density",
    subtitle = str_c("Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, \nHas Gun Manufacturer"),
    color = "Temperature\nRange"
  ) +
  theme_minimal() +
  small_text


g4 <- ggplot(combined_data %>% filter(candidate), 
       aes(x=pop_density, y=percent_farmland, color = percent_farm_failed)) +
  geom_point(size=0.5, alpha = 0.6) +
  scale_color_gradient(high="red", low="blue") +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"), ")"),
    y="Percent Farmland",
    title = "Percent Farmland vs. Population Density",
    subtitle = str_c("Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, \nHas Gun Manufacturer"),
    color = "% Farmland\nFailed"
  ) +
  theme_minimal() +
  small_text

library(gridExtra)
grid.arrange(g1, g2, g3,g4, nrow = 2)
```

-   You can use Notebook Output to see these graphs much more clearly
-   Different variables were compared to the list of candidate counties, allowing, visually, the best counties to jump out more easily

# Zombie Index Parameters

-   Density plots of candidate counties were used in order find thresholds for certain values

    -   Drought severity

    -   Average Temperature

    -   Temperature Variance

    -   Percent Farmland Failed

-   These ranges were then used when creating the Zombie index, giving us our list of counties to go to during a zombie apocalypse

# Drought Severity Index Threshold

```{r}

ggplot(combined_data%>%filter(!is.na(candidate)), 
       aes(x=drought, y=candidate, color=candidate, fill=candidate)) +
  geom_density_ridges(alpha=0.7, show.legend=FALSE) +
  labs(
    title = "Drought Severity Index Distribution for Candidate and Non Candidate Counties",
    subtitle = str_c("Candidate County: Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, Has Gun Manufacturer"),
    y = "Candidate County",
    x = "Drought Severity Index"
  ) +
  theme_minimal()
```

-   Our drought severity parameter threshold ranged between 0 to 3, as average to slightly wet would most likely yield the most crops
-   in terms of living as well. Dry climates and lack of water may become health issues later on.

# Average Temperature Threshold

```{r}

ggplot(combined_data%>%filter(!is.na(candidate)), 
       aes(x=avg_temp, y=candidate, color=candidate, fill=candidate)) +
  geom_density_ridges(alpha=0.7, show.legend=FALSE) +
  labs(
    title = "Average Temperature Distribution for Candidate and Non Candidate Counties",
    subtitle = str_c("Candidate County: Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, Has Gun Manufacturer"),
    y = "Candidate County",
    x = "Average Temperature"
  ) +
  theme_minimal()
```

-   Average temperature threshold ranged from 55 to 71, contains most candidate counties.
-   This feels reasonable as well, as it isn't too cold nor too warm, which may cause quality of life or health issues

# Temperature Variation Threshold

```{r}

ggplot(combined_data%>%filter(!is.na(candidate)), 
       aes(x=temp_range, y=candidate, color=candidate, fill=candidate)) +
  geom_density_ridges(alpha=0.7, show.legend=FALSE) +
  labs(
    title = "Temperature Range Distribution for Candidate and Non Candidate Counties",
    subtitle = str_c("Candidate County: Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, Has Gun Manufacturer"),
    y = "Candidate County",
    x = "Temperature Range"
  ) +
  theme_minimal()
```

-   Temperature range threshold was less than 75 degrees throughout the year, contains most candidate counties.

# Percent Farmland Failed Threshold

```{r}

ggplot(combined_data%>%filter(!is.na(candidate)), 
       aes(x=percent_farm_failed, y=candidate, color=candidate, fill=candidate)) +
  geom_density_ridges(alpha=0.7, show.legend=FALSE) +
  labs(
    title = "Percent Farmland Failed Distribution for Candidate and Non Candidate Counties",
    subtitle = str_c("Candidate County: Population Density < 100 people/mi", supsc("2"),
                     ", Percent Farmland > 60%, Has Gun Manufacturer"),
    y = "Candidate County",
    x = "Percent Farmland Failed"
  ) +
  theme_minimal()
```

-   Percent farmland failed below 0.1, or 10%, contains most candidate counties.
-   We reason that 90% farmland success was enough for reliable food production

# Zombie Index

-   Zombie Index was calculated based on ideal ranges for parameters. Lower index is a more ideal county.

# Sensitivity to Parameters

-   To display how the zombie index varies based on parameters, plots show the sensitivity of the index value to each parameter.

```{r}
par(mfrow=c(2,3))
small_text <- theme(
  plot.title    = element_text(size = 9),
  plot.subtitle = element_text(size = 7),
  axis.title    = element_text(size = 7),
  axis.text     = element_text(size = 6),
  legend.title  = element_text(size = 7),
  legend.text   = element_text(size = 6)
)
p1 <- ggplot(indicies %>% filter(index_1 < 50), aes(x=pop_density, y=index_1)) +
  geom_point(size=0.5, alpha = 0.6) +
  labs(
    x=str_c("Population Density (people/mi", supsc("2"),")"),
    y="Zombie Index",
    title = "Zombie Index vs. Population Density",
    subtitle = "Zombie Index < 50"
  ) +
  theme_minimal() +
  small_text

p2 <- ggplot(indicies %>% filter(index_1 < 50), aes(x=percent_farmland, y=index_1)) +
  geom_point(size=0.5, alpha = 0.6) +
  labs(
    x="Percent Farmland",
    y="Zombie Index",
    title = "Zombie Index vs. Percent Farmland",
    subtitle = "Zombie Index < 50"
  ) +
  theme_minimal() +
  small_text

p3 <- ggplot(indicies %>% filter(index_1 < 50), aes(x=percent_farm_failed, y=index_1)) +
  geom_point(size=0.5, alpha = 0.6) +
  labs(
    x="Percent Farmland Failed",
    y="Zombie Index",
    title = "Zombie Index vs. Percent Farmland Failed",
    subtitle = "Zombie Index < 50"
  ) +
  theme_minimal() + 
  small_text

p4 <- ggplot(indicies %>% filter(index_1 < 50), aes(x=avg_temp, y=index_1)) +
  geom_point(size=0.5, alpha = 0.6) +
  labs(
    x="Average Temperature",
    y="Zombie Index",
    title = "Zombie Index vs. Average Temperature",
    subtitle = "Zombie Index < 50"
  ) +
  theme_minimal() + 
  small_text

p5 <- ggplot(indicies %>% filter(index_1 < 50), aes(x=temp_range, y=index_1)) +
  geom_point(size=0.5, alpha = 0.6) +
  labs(
    x="Temperature Range",
    y="Zombie Index",
    title = "Zombie Index vs. Temperature Range",
    subtitle = "Zombie Index < 50"
  ) +
  theme_minimal() + 
  small_text

p6 <- ggplot(indicies %>% filter(index_1 < 50), aes(x=drought, y=index_1)) +
  geom_point(size=0.5, alpha = 0.6) +
  labs(
    x="Drought Severity Index",
    y="Zombie Index",
    title = "Zombie Index vs. Drought Severity Index",
    subtitle = "Zombie Index < 50"
  ) +
  theme_minimal() + 
  small_text
grid.arrange(p1, p2, p3,p4,p5,p6, nrow = 2)
```
# Maps of Important Statistics
-    Here are a few examples of variable maps for our variables. For the sake of brevity, we only include drought severity and precipitation here. In the next slide, we show the effect of all variables taken together.

```{r}
map_data <- counties_sf %>%
  inner_join(combined_data, by = c("GEOID" = "GEOID"))
ggplot(map_data) +
  geom_sf(aes(fill = drought), color = NA) +
  scale_fill_viridis_c(option = "inferno") +
  theme_minimal() +
  labs(
    title = "County Map of Drought",
    fill = "Severity"
  )
```
# Maps of Important Statistics

```{r}
map_data <- counties_sf %>%
  inner_join(combined_data, by = c("GEOID" = "GEOID"))
ggplot(map_data) +
  geom_sf(aes(fill = precip), color = NA) +
  scale_fill_viridis_c(option = "plasma") +
  theme_minimal() +
  labs(
    title = "County Map of Precipitation",
    fill = "Rainfall"
  )
```

# Map of the MOST Important Statistic!

-   This display demonstrates the areas near you that would be best for surviving zombies based on all our variables.
-   DON'T go to Monroe County, Florida.

```{r}
map_data <- counties_sf %>%
  inner_join(combined_data, by = c("GEOID" = "GEOID"))
ggplot(map_data) +
  geom_sf(aes(fill = index_1), color = NA) +
  scale_fill_viridis_c(option = "viridis") +
  theme_minimal() +
  labs(
    title = "County Map of Zombie Apocalypse Survival Index",
    fill = "Index Value"
  )
```

# GOOD LUCK!!!
